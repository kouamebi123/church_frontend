import{r as d,j as t,h as I,B as b,T as W,i,M as E,b2 as ne,b3 as de,b4 as ue,b5 as w,b6 as s,b7 as ce,I as U,aS as me,D as he,u as pe,v as fe,w as _e,F as ge,s as xe,t as ve,x as be,n as V,S as Ce,A as je,b8 as Se}from"./mui-mRVmBbre.js";import{c as ye,b as Be,q as De,L as Ie,i as o,n as We,a as Ee,h as we,r as Te,t as C,s as u,v as Le}from"./index-tM-Ac5N7.js";import{f as H}from"./fr-CiOJZWTq.js";import{E as qe}from"./ErrorMessage-G4UKRMcw.js";import{D as Pe}from"./DeleteConfirmDialog-CIKPnhKB.js";import{u as ke}from"./useApi-DgHcifJO.js";import{u as Me}from"./useNotification-Dvvg7ylT.js";import{A as Ne}from"./AccessControl-DiRRByFc.js";import{u as Re}from"./router-BwhLjOj0.js";import{f as Y}from"./utils-DP_tgNw_.js";import"./vendor-Bzgz95E1.js";import"./redux-DbjaNwcH.js";const Oe=Te({culte:C().required("Le type de culte est requis"),orateur:C().required("L'orateur est requis"),date:Le().required("La date est requise"),total_adultes:u().min(0,"Le nombre doit être positif").required("Le nombre d'adultes est requis"),total_enfants:u().min(0,"Le nombre doit être positif").required("Le nombre d'enfants est requis"),total_chantres:u().min(0,"Le nombre doit être positif").required("Le nombre de chantres est requis"),total_protocoles:u().min(0,"Le nombre doit être positif").required("Le nombre de protocoles est requis"),total_multimedia:u().min(0,"Le nombre doit être positif").required("Le nombre de multimedia est requis"),total_respo_ecodim:C().required("Le responsable ECODIM est requis"),total_animateurs_ecodim:u().min(0,"Le nombre doit être positif").required("Le nombre d'animateurs ECODIM est requis"),total_enfants_ecodim:u().min(0,"Le nombre doit être positif").required("Le nombre d'enfants ECODIM est requis"),superviseur:C().required("Le superviseur est requis")}),et=()=>{const{canUpdateServices:T,canDeleteServices:L}=ye(),{selectedChurch:p}=Be();Re();const[j,q]=d.useState(0),[f,z]=d.useState(10),[G,P]=d.useState(!1),[k,M]=d.useState(null),[J,K]=d.useState([]),[Q,N]=d.useState(!1),[c,R]=d.useState(null),[n,X]=d.useState({type:"",date:"",collecteur:"",superviseur:""}),{services:_,loading:Z,error:O,fetchServices:g,updateService:ee,deleteService:te}=ke(),{notification:S,showSuccess:$,showError:m,hideNotification:A}=Me(),F=()=>{N(!1),R(null)},re=async()=>{try{const r=await Ee.users.getAll({role:"SUPERVISEUR"}),a=r.data?.data||r.data||[];K(a.map(l=>({id:l.id||l._id,username:l.username||l.pseudo||o.t("common_text.unknownName"),pseudo:l.pseudo||l.username||o.t("common_text.unknownName")})))}catch(r){we(r,o.t("errors.api.loadUsers")),m(o.t("errors.api.loadUsers"))}};d.useEffect(()=>{g(),re()},[g]);const h=d.useMemo(()=>!p?.id||!_||_.length===0?[]:_.filter(a=>(a.eglise?.id||a.eglise_id)===p.id),[_,p]);d.useEffect(()=>{h.length>0},[h]);const oe=r=>{M(r),P(!0),e.setValues({culte:r.culte||"",orateur:r.orateur||"",date:r.date||new o.t("common.time.days")().toISOString().split("T")[0],total_adultes:r.total_adultes||0,total_enfants:r.total_enfants||0,total_chantres:r.total_chantres||0,total_protocoles:r.total_protocoles||0,total_multimedia:r.total_multimedia||0,total_respo_ecodim:r.total_respo_ecodim||0,total_animateurs_ecodim:r.total_animateurs_ecodim||0,total_enfants_ecodim:r.total_enfants_ecodim||0,superviseur:r.superviseur?.id||r.superviseur?._id||""})},y=()=>{P(!1),M(null),e.setValues({culte:"",orateur:"",date:new Date().toISOString().split("T")[0],total_adultes:0,total_enfants:0,total_chantres:0,total_protocoles:0,total_multimedia:0,total_respo_ecodim:0,total_animateurs_ecodim:0,total_enfants_ecodim:0,superviseur:""}),e.setTouched({}),e.setErrors({})},e=De({initialValues:{culte:"",orateur:"",date:new Date,total_adultes:"",total_enfants:"",total_chantres:"",total_protocoles:"",total_multimedia:"",total_respo_ecodim:"",total_animateurs_ecodim:"",total_enfants_ecodim:"",superviseur:""},validationSchema:Oe,onSubmit:async r=>{try{const a=k?.id||k?._id;if(!a){m(o.t("errors.validation.serviceIdNotFound"));return}const l={culte:r.culte,orateur:r.orateur,date:r.date,total_adultes:parseInt(r.total_adultes)||0,total_enfants:parseInt(r.total_enfants)||0,total_chantres:parseInt(r.total_chantres)||0,total_protocoles:parseInt(r.total_protocoles)||0,total_multimedia:parseInt(r.total_multimedia)||0,total_respo_ecodim:parseInt(r.total_respo_ecodim)||0,total_animateurs_ecodim:parseInt(r.total_animateurs_ecodim)||0,total_enfants_ecodim:parseInt(r.total_enfants_ecodim)||0,superviseur_id:r.superviseur||null};await ee(a,l);const D=h.map(v=>(v.id||v._id)===a?{...v,...l}:v);g(D),y(),$(o.t("success.serviceUpdated"))}catch{m(o.t("errors.api.updateService"))}}}),x=r=>{X({...n,[r.target.name]:r.target.value})},B=h.filter(r=>{if(n.type&&n.type!=="Tous"&&r.culte!==n.type)return!1;if(n.date){const a=new Date(n.date),l=new Date(r.date);if(a.getFullYear()!==l.getFullYear()||a.getMonth()!==l.getMonth()||a.getDate()!==l.getDate())return!1}return!(n.collecteur&&!r.collecteur_culte?.username.toLowerCase().includes(n.collecteur.toLowerCase())||n.superviseur&&!r.superviseur?.username.toLowerCase().includes(n.superviseur.toLowerCase()))}),se=(r,a)=>{q(a)},ae=r=>{z(parseInt(r.target.value,10)),q(0)},le=r=>{R(r),N(!0)},ie=async()=>{if(!c)return;const r=c?.id||c?._id;if(!r){m(o.t("errors.validation.serviceIdNotFound"));return}try{await te(r);const a=h.filter(l=>(l.id||l._id)!==r);g(a),$(o.t("success.serviceDeleted"))}catch{m(o.t("errors.api.deleteService"))}finally{F()}};return Z?t.jsx(Ie,{titre:o.t("loading.loadingServices")}):O?t.jsx(qe,{message:O}):p?.id?t.jsx(Ne,{allowedRoles:["SUPER_ADMIN","ADMIN","MANAGER","SUPERVISEUR"],children:t.jsxs(I,{"data-aos":"fade-up",elevation:3,sx:{p:4},children:[t.jsxs(b,{mb:4,children:[t.jsx(W,{variant:"h6",gutterBottom:!0,children:o.t("common.actions.filter")}),t.jsxs(b,{display:"flex",gap:2,flexWrap:"wrap",children:[t.jsx(i,{select:!0,id:"services-filter-type",name:"type",label:o.t("services.list.typeCulte"),value:n.type,onChange:x,sx:{minWidth:200,backgroundColor:"#fdfdfd"},autoComplete:"off",children:We.map(r=>t.jsx(E,{value:r.value,children:r.label},r.value))}),t.jsx(i,{type:"date",id:"services-filter-date",name:"date",label:o.t("common.time.days"),value:n.date,onChange:x,InputLabelProps:{shrink:!0},sx:{minWidth:200,backgroundColor:"#fdfdfd"},autoComplete:"off"}),t.jsx(i,{id:"services-filter-collecteur",name:"collecteur",label:o.t("services.list.collecteur"),value:n.collecteur,onChange:x,sx:{minWidth:200,backgroundColor:"#fdfdfd"},autoComplete:"off"}),t.jsx(i,{id:"services-filter-superviseur",name:"superviseur",label:o.t("services.list.superviseur"),value:n.superviseur,onChange:x,sx:{minWidth:200,backgroundColor:"#fdfdfd"},autoComplete:"off"})]})]}),t.jsx(ne,{component:I,sx:{backgroundColor:"primary.light",maxHeight:"80vh",overflow:"auto"},children:t.jsxs(de,{sx:{backgroundColor:"#fff"},children:[t.jsx(ue,{sx:{backgroundColor:"#dcdcdc"},children:t.jsxs(w,{children:[t.jsx(s,{sx:{fontWeight:"bold"},children:o.t("services.list.typeCulte")}),t.jsx(s,{sx:{fontWeight:"bold"},children:o.t("services.list.orateur")}),t.jsx(s,{sx:{fontWeight:"bold"},children:o.t("common.time.days")}),t.jsx(s,{align:"right",sx:{fontWeight:"bold"},children:o.t("services.list.adultes")}),t.jsx(s,{align:"right",sx:{fontWeight:"bold"},children:o.t("services.list.enfants")}),t.jsx(s,{align:"right",sx:{fontWeight:"bold"},children:o.t("services.list.chantres")}),t.jsx(s,{align:"right",sx:{fontWeight:"bold"},children:o.t("services.list.protocoles")}),t.jsx(s,{align:"right",sx:{fontWeight:"bold"},children:o.t("services.list.multimedia")}),t.jsx(s,{align:"right",sx:{fontWeight:"bold"},children:o.t("services.list.respEcodim")}),t.jsx(s,{align:"right",sx:{fontWeight:"bold"},children:o.t("services.list.animEcodim")}),t.jsx(s,{align:"right",sx:{fontWeight:"bold"},children:o.t("services.list.enfEcodim")}),t.jsx(s,{sx:{fontWeight:"bold"},children:o.t("services.list.collecteur")}),t.jsx(s,{sx:{fontWeight:"bold"},children:o.t("services.list.superviseur")}),t.jsx(s,{align:"center",sx:{fontWeight:"bold",minWidth:120},children:o.t("common.actions.title")})]})}),t.jsxs(ce,{sx:{backgroundColor:"white"},children:[B.slice(j*f,j*f+f).map(r=>{const a=r.id||r._id;return t.jsxs(w,{hover:!0,sx:{transition:"background-color 0.2s","&:hover":{backgroundColor:"rgba(0, 0, 0, 0.03)"}},children:[t.jsx(s,{children:r.culte}),t.jsx(s,{children:r.orateur}),t.jsx(s,{children:Y(new Date(r.date),"dd MMMM yyyy",{locale:H})}),t.jsx(s,{align:"right",children:r.total_adultes||0}),t.jsx(s,{align:"right",children:r.total_enfants||0}),t.jsx(s,{align:"right",children:r.total_chantres||0}),t.jsx(s,{align:"right",children:r.total_protocoles||0}),t.jsx(s,{align:"right",children:r.total_multimedia||0}),t.jsx(s,{align:"right",children:r.total_respo_ecodim||0}),t.jsx(s,{align:"right",children:r.total_animateurs_ecodim||0}),t.jsx(s,{align:"right",children:r.total_enfants_ecodim||0}),t.jsx(s,{children:r.collecteur_culte?r.collecteur_culte.username:""}),t.jsx(s,{children:r.superviseur?r.superviseur.username:""}),t.jsxs(s,{align:"center",children:[t.jsx(U,{color:"primary",onClick:()=>oe(r),disabled:!T,title:T?"":o.t("errors.adminOnlyRead"),children:t.jsx(me,{})}),t.jsx(U,{color:"error",onClick:()=>le(r),disabled:!L,title:L?"":o.t("errors.adminOnlyRead"),children:t.jsx(he,{})})]})]},a)}),B.length===0&&t.jsx(w,{children:t.jsx(s,{colSpan:14,align:"center",children:o.t("services.list.noServices")})})]})]})}),t.jsxs(pe,{open:G,onClose:y,maxWidth:"md",fullWidth:!0,children:[t.jsx(fe,{children:o.t("services.list.editService")}),t.jsxs("form",{onSubmit:e.handleSubmit,children:[t.jsx(_e,{children:t.jsxs(b,{sx:{display:"flex",flexDirection:"column",gap:2},children:[t.jsx(i,{fullWidth:!0,id:"services-list-edit-culte",name:"culte",label:o.t("services.list.typeCulte"),value:e.values.culte,onChange:e.handleChange,onBlur:e.handleBlur,error:e.touched.culte&&!!e.errors.culte,helperText:e.touched.culte&&e.errors.culte,autoComplete:"off"}),t.jsx(i,{fullWidth:!0,id:"services-list-edit-orateur",name:"orateur",label:o.t("services.list.orateur"),value:e.values.orateur,onChange:e.handleChange,onBlur:e.handleBlur,error:e.touched.orateur&&!!e.errors.orateur,helperText:e.touched.orateur&&e.errors.orateur,autoComplete:"name"}),t.jsx(i,{fullWidth:!0,type:"date",id:"services-list-edit-date",name:"date",value:e.values.date,onChange:e.handleChange,onBlur:e.handleBlur,error:e.touched.date&&!!e.errors.date,helperText:e.touched.date&&e.errors.date,InputLabelProps:{shrink:!0},autoComplete:"off"}),t.jsx(i,{fullWidth:!0,id:"services-list-edit-total-adultes",name:"total_adultes",label:`Nombre d'${o.t("services.list.adultes")}`,type:"number",value:e.values.total_adultes,onChange:e.handleChange,onBlur:e.handleBlur,error:e.touched.total_adultes&&!!e.errors.total_adultes,helperText:e.touched.total_adultes&&e.errors.total_adultes,autoComplete:"off"}),t.jsx(i,{fullWidth:!0,id:"services-list-edit-total-enfants",name:"total_enfants",label:`Nombre d'${o.t("services.list.enfants")}`,type:"number",value:e.values.total_enfants,onChange:e.handleChange,onBlur:e.handleBlur,error:e.touched.total_enfants&&!!e.errors.total_enfants,helperText:e.touched.total_enfants&&e.errors.total_enfants,autoComplete:"off"}),t.jsx(i,{fullWidth:!0,id:"services-list-edit-total-chantres",name:"total_chantres",label:`Nombre de ${o.t("services.list.chantres")}`,type:"number",value:e.values.total_chantres,onChange:e.handleChange,onBlur:e.handleBlur,error:e.touched.total_chantres&&!!e.errors.total_chantres,helperText:e.touched.total_chantres&&e.errors.total_chantres,autoComplete:"off"}),t.jsx(i,{fullWidth:!0,id:"services-list-edit-total-protocoles",name:"total_protocoles",label:`Nombre de ${o.t("services.list.protocoles")}`,type:"number",value:e.values.total_protocoles,onChange:e.handleChange,onBlur:e.handleBlur,error:e.touched.total_protocoles&&!!e.errors.total_protocoles,helperText:e.touched.total_protocoles&&e.errors.total_protocoles,autoComplete:"off"}),t.jsx(i,{fullWidth:!0,id:"services-list-edit-total-multimedia",name:"total_multimedia",label:`Nombre ${o.t("services.list.multimedia")}`,type:"number",value:e.values.total_multimedia,onChange:e.handleChange,onBlur:e.handleBlur,error:e.touched.total_multimedia&&!!e.errors.total_multimedia,helperText:e.touched.total_multimedia&&e.errors.total_multimedia,autoComplete:"off"}),t.jsx(i,{fullWidth:!0,id:"services-list-edit-total-respo-ecodim",name:"total_respo_ecodim",label:`Responsable ${o.t("services.list.respEcodim")}`,value:e.values.total_respo_ecodim,onChange:e.handleChange,onBlur:e.handleBlur,error:e.touched.total_respo_ecodim&&!!e.errors.total_respo_ecodim,helperText:e.touched.total_respo_ecodim&&e.errors.total_respo_ecodim,autoComplete:"name"}),t.jsx(i,{fullWidth:!0,id:"services-list-edit-total-animateurs-ecodim",name:"total_animateurs_ecodim",label:`Nombre d'${o.t("services.list.animEcodim")}`,type:"number",value:e.values.total_animateurs_ecodim,onChange:e.handleChange,onBlur:e.handleBlur,error:e.touched.total_animateurs_ecodim&&!!e.errors.total_animateurs_ecodim,helperText:e.touched.total_animateurs_ecodim&&e.errors.total_animateurs_ecodim,autoComplete:"off"}),t.jsx(i,{fullWidth:!0,id:"services-list-edit-total-enfants-ecodim",name:"total_enfants_ecodim",label:`Nombre d'${o.t("services.list.enfants")} ${o.t("services.list.enfEcodim")}`,type:"number",value:e.values.total_enfants_ecodim,onChange:e.handleChange,onBlur:e.handleBlur,error:e.touched.total_enfants_ecodim&&!!e.errors.total_enfants_ecodim,helperText:e.touched.total_enfants_ecodim&&e.errors.total_enfants_ecodim,autoComplete:"off"}),t.jsxs(ge,{fullWidth:!0,children:[t.jsx(xe,{id:"services-list-edit-superviseur-label",children:o.t("services.list.superviseur")}),t.jsxs(ve,{id:"services-list-edit-superviseur",name:"superviseur",value:e.values.superviseur||"",onChange:e.handleChange,onBlur:e.handleBlur,error:e.touched.superviseur&&!!e.errors.superviseur,labelId:"services-list-edit-superviseur-label",autoComplete:"off",children:[t.jsx(E,{value:"",children:o.t("services.list.selectSuperviseur")}),J.map(r=>t.jsx(E,{value:r._id||r.id,children:r.username||r.pseudo},r._id||r.id))]}),e.touched.superviseur&&e.errors.superviseur&&t.jsx("div",{style:{color:"red",fontSize:"0.75rem"},children:e.errors.superviseur})]})]})}),t.jsxs(be,{children:[t.jsx(V,{onClick:y,color:"primary",children:o.t("common.actions.cancel")}),t.jsx(V,{type:"submit",variant:"contained",color:"primary",children:o.t("common.actions.save")})]})]})]}),t.jsx(Pe,{open:Q,title:o.t("services.list.deleteService"),content:c?`Êtes-vous sûr de vouloir supprimer le service du ${Y(new Date(c.date),"dd/MM/yyyy",{locale:H})} ?`:"Êtes-vous sûr de vouloir supprimer ce service ?",onClose:F,onConfirm:ie}),t.jsx(Ce,{open:S.open,autoHideDuration:2e3,onClose:A,anchorOrigin:{vertical:"bottom",horizontal:"center"},children:t.jsx(je,{onClose:A,severity:S.severity,sx:{width:"100%"},children:S.message})}),t.jsx(Se,{component:"div",count:B.length,page:j,onPageChange:se,rowsPerPage:f,onRowsPerPageChange:ae,labelRowsPerPage:o.t("common.pagination.rowsPerPage")})]})}):t.jsx(I,{"data-aos":"fade-up",elevation:3,sx:{p:4},children:t.jsxs(b,{sx:{textAlign:"center",py:4},children:[t.jsx(W,{variant:"h6",color:"text.secondary",gutterBottom:!0,children:o.t("home.noChurchSelected")}),t.jsx(W,{variant:"body1",color:"text.secondary",children:o.t("home.selectChurchForServices")})]})})};export{et as default};
