import{r as d,j as t,h as D,B as b,T as I,i,M as W,b2 as ne,b3 as de,b4 as ce,b5 as E,b6 as a,b7 as ue,I as U,aS as he,D as me,u as pe,v as fe,w as _e,F as ge,s as xe,t as ve,x as be,n as V,S as Ce,A as je,b8 as Se}from"./mui-mRVmBbre.js";import{c as ye,b as we,q as Be,L as De,i as o,n as Ie,a as We,h as Ee,r as Te,t as C,s as c,v as Le}from"./index-tq1YSY20.js";import{f as H}from"./fr-CiOJZWTq.js";import{E as ke}from"./ErrorMessage-Dk1PJ2WD.js";import{D as Pe}from"./DeleteConfirmDialog-DYveqh5g.js";import{u as qe}from"./useApi-DUhR7Fl5.js";import{u as Me}from"./useNotification-Dvvg7ylT.js";import{A as Re}from"./AccessControl-kK8-PbhW.js";import{u as Ne}from"./router-BwhLjOj0.js";import{f as Y}from"./utils-DP_tgNw_.js";import"./vendor-Bzgz95E1.js";import"./redux-DbjaNwcH.js";const Fe=Te({culte:C().required("Le type de culte est requis"),orateur:C().required("L'orateur est requis"),date:Le().required("La date est requise"),total_adultes:c().min(0,"Le nombre doit être positif").required("Le nombre d'adultes est requis"),total_enfants:c().min(0,"Le nombre doit être positif").required("Le nombre d'enfants est requis"),total_chantres:c().min(0,"Le nombre doit être positif").required("Le nombre de chantres est requis"),total_protocoles:c().min(0,"Le nombre doit être positif").required("Le nombre de protocoles est requis"),total_multimedia:c().min(0,"Le nombre doit être positif").required("Le nombre de multimedia est requis"),total_respo_ecodim:C().required("Le responsable ECODIM est requis"),total_animateurs_ecodim:c().min(0,"Le nombre doit être positif").required("Le nombre d'animateurs ECODIM est requis"),total_enfants_ecodim:c().min(0,"Le nombre doit être positif").required("Le nombre d'enfants ECODIM est requis"),superviseur:C().required("Le superviseur est requis")}),et=()=>{const{canUpdateServices:T,canDeleteServices:L}=ye(),{selectedChurch:p}=we();Ne();const[j,k]=d.useState(0),[f,z]=d.useState(10),[G,P]=d.useState(!1),[q,M]=d.useState(null),[J,K]=d.useState([]),[Q,R]=d.useState(!1),[u,N]=d.useState(null),[n,X]=d.useState({type:"",date:"",collecteur:"",superviseur:""}),{services:_,loading:Z,error:F,fetchServices:g,updateService:ee,deleteService:te}=qe(),{notification:S,showSuccess:O,showError:h,hideNotification:$}=Me(),A=()=>{R(!1),N(null)},re=async()=>{try{const r=await We.users.getAll({role:"SUPERVISEUR"}),s=r.data?.data||r.data||[];K(s.map(l=>({id:l.id||l._id,username:l.username||l.pseudo||o.t("common_text.unknownName"),pseudo:l.pseudo||l.username||o.t("common_text.unknownName")})))}catch(r){Ee(r,o.t("errors.api.loadUsers")),h(o.t("errors.api.loadUsers"))}};d.useEffect(()=>{g(),re()},[g]);const m=d.useMemo(()=>!p?.id||!_||_.length===0?[]:_.filter(s=>(s.eglise?.id||s.eglise_id)===p.id),[_,p]);d.useEffect(()=>{m.length>0},[m]);const oe=r=>{M(r),P(!0),e.setValues({culte:r.culte||"",orateur:r.orateur||"",date:r.date||new o.t("common.time.days")().toISOString().split("T")[0],total_adultes:r.total_adultes||0,total_enfants:r.total_enfants||0,total_chantres:r.total_chantres||0,total_protocoles:r.total_protocoles||0,total_multimedia:r.total_multimedia||0,total_respo_ecodim:r.total_respo_ecodim||0,total_animateurs_ecodim:r.total_animateurs_ecodim||0,total_enfants_ecodim:r.total_enfants_ecodim||0,superviseur:r.superviseur?.id||r.superviseur?._id||""})},y=()=>{P(!1),M(null),e.setValues({culte:"",orateur:"",date:new Date().toISOString().split("T")[0],total_adultes:0,total_enfants:0,total_chantres:0,total_protocoles:0,total_multimedia:0,total_respo_ecodim:0,total_animateurs_ecodim:0,total_enfants_ecodim:0,superviseur:""}),e.setTouched({}),e.setErrors({})},e=Be({initialValues:{culte:"",orateur:"",date:new Date,total_adultes:"",total_enfants:"",total_chantres:"",total_protocoles:"",total_multimedia:"",total_respo_ecodim:"",total_animateurs_ecodim:"",total_enfants_ecodim:"",superviseur:""},validationSchema:Fe,onSubmit:async r=>{try{const s=q?.id||q?._id;if(!s){h(o.t("errors.validation.serviceIdNotFound"));return}const l={culte:r.culte,orateur:r.orateur,date:r.date,total_adultes:parseInt(r.total_adultes)||0,total_enfants:parseInt(r.total_enfants)||0,total_chantres:parseInt(r.total_chantres)||0,total_protocoles:parseInt(r.total_protocoles)||0,total_multimedia:parseInt(r.total_multimedia)||0,total_respo_ecodim:parseInt(r.total_respo_ecodim)||0,total_animateurs_ecodim:parseInt(r.total_animateurs_ecodim)||0,total_enfants_ecodim:parseInt(r.total_enfants_ecodim)||0,superviseur_id:r.superviseur||null};await ee(s,l);const B=m.map(v=>(v.id||v._id)===s?{...v,...l}:v);g(B),y(),O(o.t("success.serviceUpdated"))}catch{h(o.t("errors.api.updateService"))}}}),x=r=>{X({...n,[r.target.name]:r.target.value})},w=m.filter(r=>{if(n.type&&n.type!=="Tous"&&r.culte!==n.type)return!1;if(n.date){const s=new Date(n.date),l=new Date(r.date);if(s.getFullYear()!==l.getFullYear()||s.getMonth()!==l.getMonth()||s.getDate()!==l.getDate())return!1}return!(n.collecteur&&!r.collecteur_culte?.username.toLowerCase().includes(n.collecteur.toLowerCase())||n.superviseur&&!r.superviseur?.username.toLowerCase().includes(n.superviseur.toLowerCase()))}),ae=(r,s)=>{k(s)},se=r=>{z(parseInt(r.target.value,10)),k(0)},le=r=>{N(r),R(!0)},ie=async()=>{if(!u)return;const r=u?.id||u?._id;if(!r){h(o.t("errors.validation.serviceIdNotFound"));return}try{await te(r);const s=m.filter(l=>(l.id||l._id)!==r);g(s),O(o.t("success.serviceDeleted"))}catch{h(o.t("errors.api.deleteService"))}finally{A()}};return Z?t.jsx(De,{titre:o.t("loading.loadingServices")}):F?t.jsx(ke,{message:F}):p?.id?t.jsx(Re,{allowedRoles:["SUPER_ADMIN","ADMIN","MANAGER","SUPERVISEUR"],children:t.jsxs(D,{"data-aos":"fade-up",elevation:0,sx:{p:5,background:"rgba(255, 255, 255, 0.95)",backdropFilter:"blur(10px)",borderRadius:"24px",border:"1px solid rgba(102, 45, 145, 0.1)",boxShadow:"0 10px 40px rgba(102, 45, 145, 0.12)"},children:[t.jsxs(b,{mb:4,children:[t.jsx(I,{variant:"h6",gutterBottom:!0,sx:{fontWeight:700,color:"primary.main",mb:2},children:o.t("common.actions.filter")}),t.jsxs(b,{display:"flex",gap:2,flexWrap:"wrap",children:[t.jsx(i,{select:!0,id:"services-filter-type",name:"type",label:o.t("services.list.typeCulte"),value:n.type,onChange:x,sx:{minWidth:200,backgroundColor:"#fdfdfd"},autoComplete:"off",children:Ie.map(r=>t.jsx(W,{value:r.value,children:r.label},r.value))}),t.jsx(i,{type:"date",id:"services-filter-date",name:"date",label:o.t("common.time.days"),value:n.date,onChange:x,InputLabelProps:{shrink:!0},sx:{minWidth:200,backgroundColor:"#fdfdfd"},autoComplete:"off"}),t.jsx(i,{id:"services-filter-collecteur",name:"collecteur",label:o.t("services.list.collecteur"),value:n.collecteur,onChange:x,sx:{minWidth:200,backgroundColor:"#fdfdfd"},autoComplete:"off"}),t.jsx(i,{id:"services-filter-superviseur",name:"superviseur",label:o.t("services.list.superviseur"),value:n.superviseur,onChange:x,sx:{minWidth:200,backgroundColor:"#fdfdfd"},autoComplete:"off"})]})]}),t.jsx(ne,{component:D,sx:{backgroundColor:"primary.light",maxHeight:"80vh",overflow:"auto"},children:t.jsxs(de,{sx:{backgroundColor:"#fff"},children:[t.jsx(ce,{children:t.jsxs(E,{children:[t.jsx(a,{sx:{fontWeight:700,color:"white"},children:o.t("services.list.typeCulte")}),t.jsx(a,{sx:{fontWeight:700,color:"white"},children:o.t("services.list.orateur")}),t.jsx(a,{sx:{fontWeight:700,color:"white"},children:o.t("common.time.days")}),t.jsx(a,{align:"right",sx:{fontWeight:700,color:"white"},children:o.t("services.list.adultes")}),t.jsx(a,{align:"right",sx:{fontWeight:700,color:"white"},children:o.t("services.list.enfants")}),t.jsx(a,{align:"right",sx:{fontWeight:700,color:"white"},children:o.t("services.list.chantres")}),t.jsx(a,{align:"right",sx:{fontWeight:700,color:"white"},children:o.t("services.list.protocoles")}),t.jsx(a,{align:"right",sx:{fontWeight:700,color:"white"},children:o.t("services.list.multimedia")}),t.jsx(a,{align:"right",sx:{fontWeight:700,color:"white"},children:o.t("services.list.respEcodim")}),t.jsx(a,{align:"right",sx:{fontWeight:700,color:"white"},children:o.t("services.list.animEcodim")}),t.jsx(a,{align:"right",sx:{fontWeight:700,color:"white"},children:o.t("services.list.enfEcodim")}),t.jsx(a,{sx:{fontWeight:700,color:"white"},children:o.t("services.list.collecteur")}),t.jsx(a,{sx:{fontWeight:700,color:"white"},children:o.t("services.list.superviseur")}),t.jsx(a,{align:"center",sx:{fontWeight:700,color:"white",minWidth:120},children:o.t("common.actions.title")})]})}),t.jsxs(ue,{sx:{backgroundColor:"white"},children:[w.slice(j*f,j*f+f).map(r=>{const s=r.id||r._id;return t.jsxs(E,{hover:!0,sx:{transition:"background-color 0.2s","&:hover":{backgroundColor:"rgba(0, 0, 0, 0.03)"}},children:[t.jsx(a,{children:r.culte}),t.jsx(a,{children:r.orateur}),t.jsx(a,{children:Y(new Date(r.date),"dd MMMM yyyy",{locale:H})}),t.jsx(a,{align:"right",children:r.total_adultes||0}),t.jsx(a,{align:"right",children:r.total_enfants||0}),t.jsx(a,{align:"right",children:r.total_chantres||0}),t.jsx(a,{align:"right",children:r.total_protocoles||0}),t.jsx(a,{align:"right",children:r.total_multimedia||0}),t.jsx(a,{align:"right",children:r.total_respo_ecodim||0}),t.jsx(a,{align:"right",children:r.total_animateurs_ecodim||0}),t.jsx(a,{align:"right",children:r.total_enfants_ecodim||0}),t.jsx(a,{children:r.collecteur_culte?r.collecteur_culte.username:""}),t.jsx(a,{children:r.superviseur?r.superviseur.username:""}),t.jsxs(a,{align:"center",children:[t.jsx(U,{color:"primary",onClick:()=>oe(r),disabled:!T,title:T?"":o.t("errors.adminOnlyRead"),children:t.jsx(he,{})}),t.jsx(U,{color:"error",onClick:()=>le(r),disabled:!L,title:L?"":o.t("errors.adminOnlyRead"),children:t.jsx(me,{})})]})]},s)}),w.length===0&&t.jsx(E,{children:t.jsx(a,{colSpan:14,align:"center",children:o.t("services.list.noServices")})})]})]})}),t.jsxs(pe,{open:G,onClose:y,maxWidth:"md",fullWidth:!0,PaperProps:{sx:{borderRadius:"24px",boxShadow:"0 20px 60px rgba(102, 45, 145, 0.15)",background:"rgba(255, 255, 255, 0.98)",backdropFilter:"blur(20px)",border:"2px solid rgba(102, 45, 145, 0.1)"}},children:[t.jsx(fe,{sx:{fontWeight:700,background:"linear-gradient(135deg, rgb(59, 20, 100) 0%, #662d91 50%, #9e005d 100%)",WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent"},children:o.t("services.list.editService")}),t.jsxs("form",{onSubmit:e.handleSubmit,children:[t.jsx(_e,{children:t.jsxs(b,{sx:{display:"flex",flexDirection:"column",gap:2},children:[t.jsx(i,{fullWidth:!0,id:"services-list-edit-culte",name:"culte",label:o.t("services.list.typeCulte"),value:e.values.culte,onChange:e.handleChange,onBlur:e.handleBlur,error:e.touched.culte&&!!e.errors.culte,helperText:e.touched.culte&&e.errors.culte,autoComplete:"off"}),t.jsx(i,{fullWidth:!0,id:"services-list-edit-orateur",name:"orateur",label:o.t("services.list.orateur"),value:e.values.orateur,onChange:e.handleChange,onBlur:e.handleBlur,error:e.touched.orateur&&!!e.errors.orateur,helperText:e.touched.orateur&&e.errors.orateur,autoComplete:"name"}),t.jsx(i,{fullWidth:!0,type:"date",id:"services-list-edit-date",name:"date",value:e.values.date,onChange:e.handleChange,onBlur:e.handleBlur,error:e.touched.date&&!!e.errors.date,helperText:e.touched.date&&e.errors.date,InputLabelProps:{shrink:!0},autoComplete:"off"}),t.jsx(i,{fullWidth:!0,id:"services-list-edit-total-adultes",name:"total_adultes",label:`Nombre d'${o.t("services.list.adultes")}`,type:"number",value:e.values.total_adultes,onChange:e.handleChange,onBlur:e.handleBlur,error:e.touched.total_adultes&&!!e.errors.total_adultes,helperText:e.touched.total_adultes&&e.errors.total_adultes,autoComplete:"off"}),t.jsx(i,{fullWidth:!0,id:"services-list-edit-total-enfants",name:"total_enfants",label:`Nombre d'${o.t("services.list.enfants")}`,type:"number",value:e.values.total_enfants,onChange:e.handleChange,onBlur:e.handleBlur,error:e.touched.total_enfants&&!!e.errors.total_enfants,helperText:e.touched.total_enfants&&e.errors.total_enfants,autoComplete:"off"}),t.jsx(i,{fullWidth:!0,id:"services-list-edit-total-chantres",name:"total_chantres",label:`Nombre de ${o.t("services.list.chantres")}`,type:"number",value:e.values.total_chantres,onChange:e.handleChange,onBlur:e.handleBlur,error:e.touched.total_chantres&&!!e.errors.total_chantres,helperText:e.touched.total_chantres&&e.errors.total_chantres,autoComplete:"off"}),t.jsx(i,{fullWidth:!0,id:"services-list-edit-total-protocoles",name:"total_protocoles",label:`Nombre de ${o.t("services.list.protocoles")}`,type:"number",value:e.values.total_protocoles,onChange:e.handleChange,onBlur:e.handleBlur,error:e.touched.total_protocoles&&!!e.errors.total_protocoles,helperText:e.touched.total_protocoles&&e.errors.total_protocoles,autoComplete:"off"}),t.jsx(i,{fullWidth:!0,id:"services-list-edit-total-multimedia",name:"total_multimedia",label:`Nombre ${o.t("services.list.multimedia")}`,type:"number",value:e.values.total_multimedia,onChange:e.handleChange,onBlur:e.handleBlur,error:e.touched.total_multimedia&&!!e.errors.total_multimedia,helperText:e.touched.total_multimedia&&e.errors.total_multimedia,autoComplete:"off"}),t.jsx(i,{fullWidth:!0,id:"services-list-edit-total-respo-ecodim",name:"total_respo_ecodim",label:`Responsable ${o.t("services.list.respEcodim")}`,value:e.values.total_respo_ecodim,onChange:e.handleChange,onBlur:e.handleBlur,error:e.touched.total_respo_ecodim&&!!e.errors.total_respo_ecodim,helperText:e.touched.total_respo_ecodim&&e.errors.total_respo_ecodim,autoComplete:"name"}),t.jsx(i,{fullWidth:!0,id:"services-list-edit-total-animateurs-ecodim",name:"total_animateurs_ecodim",label:`Nombre d'${o.t("services.list.animEcodim")}`,type:"number",value:e.values.total_animateurs_ecodim,onChange:e.handleChange,onBlur:e.handleBlur,error:e.touched.total_animateurs_ecodim&&!!e.errors.total_animateurs_ecodim,helperText:e.touched.total_animateurs_ecodim&&e.errors.total_animateurs_ecodim,autoComplete:"off"}),t.jsx(i,{fullWidth:!0,id:"services-list-edit-total-enfants-ecodim",name:"total_enfants_ecodim",label:`Nombre d'${o.t("services.list.enfants")} ${o.t("services.list.enfEcodim")}`,type:"number",value:e.values.total_enfants_ecodim,onChange:e.handleChange,onBlur:e.handleBlur,error:e.touched.total_enfants_ecodim&&!!e.errors.total_enfants_ecodim,helperText:e.touched.total_enfants_ecodim&&e.errors.total_enfants_ecodim,autoComplete:"off"}),t.jsxs(ge,{fullWidth:!0,children:[t.jsx(xe,{id:"services-list-edit-superviseur-label",children:o.t("services.list.superviseur")}),t.jsxs(ve,{id:"services-list-edit-superviseur",name:"superviseur",value:e.values.superviseur||"",onChange:e.handleChange,onBlur:e.handleBlur,error:e.touched.superviseur&&!!e.errors.superviseur,labelId:"services-list-edit-superviseur-label",autoComplete:"off",children:[t.jsx(W,{value:"",children:o.t("services.list.selectSuperviseur")}),J.map(r=>t.jsx(W,{value:r._id||r.id,children:r.username||r.pseudo},r._id||r.id))]}),e.touched.superviseur&&e.errors.superviseur&&t.jsx("div",{style:{color:"red",fontSize:"0.75rem"},children:e.errors.superviseur})]})]})}),t.jsxs(be,{children:[t.jsx(V,{onClick:y,color:"primary",children:o.t("common.actions.cancel")}),t.jsx(V,{type:"submit",variant:"contained",color:"primary",children:o.t("common.actions.save")})]})]})]}),t.jsx(Pe,{open:Q,title:o.t("services.list.deleteService"),content:u?`Êtes-vous sûr de vouloir supprimer le service du ${Y(new Date(u.date),"dd/MM/yyyy",{locale:H})} ?`:"Êtes-vous sûr de vouloir supprimer ce service ?",onClose:A,onConfirm:ie}),t.jsx(Ce,{open:S.open,autoHideDuration:2e3,onClose:$,anchorOrigin:{vertical:"bottom",horizontal:"center"},children:t.jsx(je,{onClose:$,severity:S.severity,sx:{width:"100%"},children:S.message})}),t.jsx(Se,{component:"div",count:w.length,page:j,onPageChange:ae,rowsPerPage:f,onRowsPerPageChange:se,labelRowsPerPage:o.t("common.pagination.rowsPerPage")})]})}):t.jsx(D,{"data-aos":"fade-up",elevation:0,sx:{p:5,borderRadius:"24px",background:"rgba(255, 255, 255, 0.95)",backdropFilter:"blur(10px)",border:"2px solid rgba(102, 45, 145, 0.1)",boxShadow:"0 10px 40px rgba(102, 45, 145, 0.08)"},children:t.jsxs(b,{sx:{textAlign:"center",py:4},children:[t.jsx(I,{variant:"h6",color:"text.secondary",gutterBottom:!0,children:o.t("home.noChurchSelected")}),t.jsx(I,{variant:"body1",color:"text.secondary",children:o.t("home.selectChurchForServices")})]})})};export{et as default};
